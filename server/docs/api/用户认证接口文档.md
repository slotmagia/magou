# 用户认证接口文档

## 概述

用户认证模块提供了完整的用户登录、退出、密码管理等功能，严格按照项目的分层架构设计模式开发，支持JWT Token认证和RBAC权限控制。

## 接口列表

### 1. 获取验证码
- **接口地址**: `GET /api/captcha`
- **接口描述**: 获取图形验证码
- **是否需要认证**: 否

#### 请求参数
无

#### 响应示例
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "captchaId": "abc123def456",
    "captchaImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH..."
  }
}
```

### 2. 用户登录
- **接口地址**: `POST /api/login`
- **接口描述**: 用户账号密码登录
- **是否需要认证**: 否

#### 请求参数
```json
{
  "username": "admin",
  "password": "123456",
  "captcha": "1234",
  "rememberMe": false
}
```

#### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名，3-50字符 |
| password | string | 是 | 密码，6-32字符（前端加密传输） |
| captcha | string | 是 | 验证码，4-6字符 |
| rememberMe | boolean | 否 | 是否记住登录状态 |

#### 响应示例
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "abc123def456ghi789",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "userInfo": {
      "id": 1,
      "username": "admin",
      "realName": "管理员",
      "avatar": "/uploads/avatar/default.png",
      "email": "admin@example.com",
      "phone": "13800138000",
      "status": 1,
      "deptId": 1
    },
    "permissions": [
      "role:list",
      "role:create",
      "role:update",
      "role:delete"
    ],
    "menuIds": [1, 2, 3, 4, 5]
  }
}
```

### 3. 用户退出
- **接口地址**: `POST /api/logout`
- **接口描述**: 用户退出登录
- **是否需要认证**: 是

#### 请求参数
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 响应示例
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "success": true,
    "message": "退出成功"
  }
}
```

### 4. 获取用户信息
- **接口地址**: `GET /api/profile`
- **接口描述**: 获取当前登录用户信息
- **是否需要认证**: 是

#### 请求头
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 响应示例
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 1,
    "username": "admin",
    "realName": "管理员",
    "avatar": "/uploads/avatar/default.png",
    "email": "admin@example.com",
    "phone": "13800138000",
    "status": 1,
    "deptId": 1,
    "position": "系统管理员",
    "loginAt": "2024-01-01 12:00:00",
    "loginCount": 10
  }
}
```

### 5. 刷新访问令牌
- **接口地址**: `POST /api/refresh-token`
- **接口描述**: 使用刷新令牌获取新的访问令牌
- **是否需要认证**: 否

#### 请求参数
```json
{
  "refreshToken": "abc123def456ghi789"
}
```

#### 响应示例
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "new_refresh_token_here",
    "expiresIn": 86400
  }
}
```

### 6. 修改密码
- **接口地址**: `POST /api/change-password`
- **接口描述**: 修改当前用户密码
- **是否需要认证**: 是

#### 请求参数
```json
{
  "oldPassword": "123456",
  "newPassword": "654321",
  "confirmPassword": "654321"
}
```

#### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| oldPassword | string | 是 | 原密码 |
| newPassword | string | 是 | 新密码，6-32字符 |
| confirmPassword | string | 是 | 确认新密码，必须与新密码一致 |

#### 响应示例
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "success": true,
    "message": "密码修改成功"
  }
}
```

## 错误响应

当接口调用失败时，会返回相应的错误信息：

```json
{
  "code": 401,
  "message": "用户名或密码错误",
  "data": null
}
```

### 常见错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 认证失败（用户名密码错误、Token无效等） |
| 403 | 权限不足 |
| 500 | 服务器内部错误 |

## 使用示例

### JavaScript示例

```javascript
class AuthAPI {
  constructor(baseURL = '/api') {
    this.baseURL = baseURL;
    this.token = localStorage.getItem('accessToken');
  }

  // 获取验证码
  async getCaptcha() {
    const response = await fetch(`${this.baseURL}/captcha`);
    return await response.json();
  }

  // 用户登录
  async login(username, password, captcha, rememberMe = false) {
    const response = await fetch(`${this.baseURL}/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        username,
        password,
        captcha,
        rememberMe
      })
    });
    
    const result = await response.json();
    if (result.code === 0) {
      this.token = result.data.accessToken;
      localStorage.setItem('accessToken', this.token);
      localStorage.setItem('refreshToken', result.data.refreshToken);
    }
    return result;
  }

  // 用户退出
  async logout() {
    const response = await fetch(`${this.baseURL}/logout`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.token}`
      },
      body: JSON.stringify({
        token: this.token
      })
    });
    
    const result = await response.json();
    if (result.code === 0) {
      this.token = null;
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
    }
    return result;
  }

  // 获取用户信息
  async getProfile() {
    const response = await fetch(`${this.baseURL}/profile`, {
      headers: {
        'Authorization': `Bearer ${this.token}`
      }
    });
    return await response.json();
  }

  // 刷新令牌
  async refreshToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    const response = await fetch(`${this.baseURL}/refresh-token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        refreshToken
      })
    });
    
    const result = await response.json();
    if (result.code === 0) {
      this.token = result.data.accessToken;
      localStorage.setItem('accessToken', this.token);
      localStorage.setItem('refreshToken', result.data.refreshToken);
    }
    return result;
  }

  // 修改密码
  async changePassword(oldPassword, newPassword, confirmPassword) {
    const response = await fetch(`${this.baseURL}/change-password`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.token}`
      },
      body: JSON.stringify({
        oldPassword,
        newPassword,
        confirmPassword
      })
    });
    return await response.json();
  }
}

// 使用示例
const auth = new AuthAPI();

// 登录流程
async function login() {
  try {
    // 1. 获取验证码
    const captchaResult = await auth.getCaptcha();
    console.log('验证码:', captchaResult.data.captchaImage);
    
    // 2. 用户登录
    const loginResult = await auth.login('admin', '123456', '1234');
    if (loginResult.code === 0) {
      console.log('登录成功:', loginResult.data.userInfo);
    } else {
      console.error('登录失败:', loginResult.message);
    }
  } catch (error) {
    console.error('请求失败:', error);
  }
}
```

## 安全说明

1. **密码加密**: 前端应该对密码进行加密后再传输，可以使用AES加密
2. **HTTPS**: 生产环境必须使用HTTPS协议
3. **Token存储**: 建议将Token存储在httpOnly的Cookie中，避免XSS攻击
4. **Token续期**: 当Token即将过期时，应自动调用刷新接口
5. **验证码**: 每次登录都应该验证图形验证码，防止暴力破解

## 注意事项

1. 所有需要认证的接口都必须在请求头中携带`Authorization: Bearer <token>`
2. Token的有效期为24小时，过期后需要使用刷新令牌获取新的访问令牌
3. 刷新令牌的有效期为7天，过期后需要重新登录
4. 密码修改后，所有已签发的Token将失效，需要重新登录 