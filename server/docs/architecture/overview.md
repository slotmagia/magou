# 项目架构概览

## 项目简介

本项目是一个基于 GoFrame v2 框架开发的客户端应用系统（client-app），主要提供用户认证、角色管理、菜单权限控制等完整的 RBAC (Role-Based Access Control) 功能的 HTTP API 服务。

## 核心目录结构

```
client-app/
├── internal/
│   ├── api/              # API接口定义
│   │   └── v1/           # API版本v1
│   │       ├── user/     # 用户认证接口
│   │       │   └── user.go
│   │       └── role/     # 角色管理接口
│   │           ├── role.go   # 角色CRUD接口
│   │           ├── menu.go   # 角色菜单权限接口
│   │           └── option.go # 角色选项接口
│   ├── cmd/              # 命令行入口
│   ├── consts/           # 常量定义
│   ├── controller/       # 控制器层
│   │   └── api/          # API控制器
│   ├── global/           # 全局初始化
│   ├── library/          # 内部公共库
│   ├── logic/            # 业务逻辑层
│   │   ├── api/          # API业务逻辑
│   │   │   ├── user.go   # 用户认证逻辑（441行）
│   │   │   └── role.go   # 角色管理逻辑（1086行）
│   │   ├── middleware/   # 中间件实现
│   │   ├── hook/         # 钩子函数
│   │   └── sys/          # 系统级逻辑
│   ├── model/            # 模型定义
│   │   ├── entity/       # 数据实体
│   │   │   ├── users.go  # 用户实体（337行，包含详细的状态管理）
│   │   │   ├── roles.go  # 角色实体（180行，包含数据权限范围）
│   │   │   └── menus.go  # 菜单实体（124行，支持层级结构）
│   │   ├── input/        # 输入模型
│   │   │   └── sysin/    # 系统输入模型
│   │   ├── output/       # 输出模型
│   │   │   └── sysout/   # 系统输出模型
│   │   ├── context.go    # 上下文模型
│   │   ├── response.go   # 响应模型
│   │   └── view.go       # 视图模型
│   ├── router/           # 路由注册
│   ├── service/          # 服务接口定义
│   │   ├── user.go       # 用户服务接口（65行）
│   │   ├── role.go       # 角色服务接口（62行）
│   │   ├── middleware.go # 中间件服务接口
│   │   ├── hook.go       # 钩子服务接口
│   │   └── view.go       # 视图服务接口
│   └── sql/              # 数据库脚本
├── utility/              # 工具包
│   ├── captcha/          # 验证码工具
│   ├── charset/          # 字符集处理
│   ├── encrypt/          # 加密工具
│   ├── simple/           # 通用工具（JWT、响应等）
│   └── validate/         # 验证工具
├── sdk/                  # SDK相关
├── web/                  # Web静态资源
├── manifest/             # 配置文件
├── logs/                 # 日志文件
├── main.go               # 入口文件
└── go.mod                # 依赖管理
```

## 分层架构

```
┌─────────────────────────────────────────────────────┐
│                     HTTP 请求                       │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                   中间件链 (Middleware)              │
│  CORS → Context → PreFilter → ResponseHandler → Auth │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                  路由层 (Router)                    │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                 控制器层 (Controller)                │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                  服务层 (Service)                   │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                  逻辑层 (Logic)                     │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                  数据层 (ORM)                      │
└─────────────────────────────────────────────────────┘
```

## 核心业务模块

### 1. 用户认证模块 (User Authentication)
- 用户登录/退出（支持JWT Token）
- 图形验证码生成与验证
- 密码修改和用户密码验证
- Token管理（AccessToken + RefreshToken机制）
- 用户信息查询和管理
- 登录状态追踪（IP、时间、次数）

### 2. 角色管理模块 (Role Management)
- 角色CRUD操作（创建、查询、更新、删除、批量删除）
- 角色状态管理（启用/禁用）
- 角色权限分配（菜单权限关联）
- 数据权限控制（全部数据、部门数据、仅本人数据等）
- 用户角色关联管理（支持主要角色设定）
- 角色复制和统计功能

### 3. 菜单权限模块 (Menu Permission)
- 层级菜单管理（目录、菜单、按钮三种类型）
- 权限标识管理
- 角色菜单关联
- 菜单显示控制（显示/隐藏、面包屑等）
- 权限验证和用户权限查询

### 4. 权限验证系统
- 基于JWT的Token验证
- 用户权限检查
- 角色权限验证
- 数据权限范围控制
- Token黑名单机制

## 技术栈

- **框架**: GoFrame v2.9.0
- **数据库**: 通过GoFrame ORM支持多种数据库
- **认证**: JWT (JSON Web Token) + RefreshToken
- **加密**: MD5 + 盐值加密（通过forgoer/openssl v1.6.0）
- **缓存**: GoFrame内置缓存机制
- **验证码**: 自定义验证码生成器
- **日志**: GoFrame内置日志系统
- **链路追踪**: Jaeger（通过gogf/gf/contrib/trace/jaeger/v2）
- **通信**: REST API

## 设计模式

1. **依赖注入模式**: 通过`service.Register*`接口实现服务注册和依赖注入
2. **接口模式**: 定义接口和实现分离，如`IUser`接口和`sUser`实现
3. **单例模式**: 各种服务实例通过全局变量保持单例
4. **工厂模式**: 通过`New*`函数创建实例，如`NewUser()`、`NewRole()`
5. **中间件模式**: 实现横切关注点，如认证、CORS、日志等

## 启动流程

```go
func main() {
    var ctx = gctx.GetInitCtx()
    global.Init(ctx)        // 全局初始化
    cmd.Main.Run(ctx)       // 启动命令
}
```

## 服务注册机制

项目使用服务注册机制管理依赖关系：

```go
// 在logic层init函数中注册服务实现
func init() {
    service.RegisterUser(NewUser())
    service.RegisterRole(NewRole())
}

// 控制器通过服务接口调用
out, err := service.User().Login(ctx, &req.UserLoginInp)
```

这种架构设计确保了系统的高内聚低耦合，具有良好的扩展性、可测试性和可维护性。
